{
  "hash": "8ef6b44ce21465a86cce9c53f4e8afa9",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Reverse engineering Janome embroidery cards (part 2)\"\ndate: 2025-05-29 \nexecute:\n  echo: false\n---\n\n\n\n\n\n\n\n(continued from [part 1](janome.html) )\n\n## Alternative connectors\n\nI found [an alternative connector on AliExpress](https://vi.aliexpress.com/item/1005006181706880.html) that looked like it might work.\n\nPutting this in the 3d printed card, and wiring up 5v and gnd, I was able to make contact with the connector:\n\n![](images/connection.jpg)\n\n## Emulating the ROM\n\nI found a project to [emulate Atari 8-bit console roms](https://github.com/robinhedwards/A8PicoCart), using a Pi Pico. I wondered if something like\nthis might work to emulate the rom cards.  The Atari project appears as a USB drive when plugged into the PC, making it easy to copy ROMS over. When\nplugged into the console it appears as the rom.   It uses an aftermarket [purple pico](https://vi.aliexpress.com/item/1005004148913144.html), which has more GPIO\npins than the official board.\n\nSearching around I found a couple of similar projects:\n\n* [wickerwaka/PicoROM](https://github.com/wickerwaka/PicoROM) - this uses a custom board to emulate 8 bit ROMS.  ROMS can be sent over USB using a command line tool.\n* [nickbild/picoROM](https://github.com/nickbild/picoROM) - this uses a standard board, and is much simpler. It's designed to emulate a 32k ROM; this is included in the\ncode at compile time.\n\nI modified nickbild's picoROM to work with the 128k ROM images the sewing machine uses.  I tested this worked by reading back data from the Pico using the circuit I built to read the ROM cards.\n\nThe Janome uses 5v, whereas the Pico uses 3.3v.  I tried building a circuit using level shifters, but couldn't get this to work (I think due to cheap breadboard).   The sewing machine either failed to recognise the card at all, failed to start (i.e. I got a blank screen), or the embroidery arm started moving randomly when the machine was turned on.\n\nI decided to try running the Pico directly off the machine, as they're [supposed to be 5v tolerant](https://hackaday.com/2023/04/05/rp2040-and-5v-logic-best-friends-this-fx9000p-confirms/)  This wasn't detected by the machine at all, though the Pico was getting\npower, and some of the address lines were high.\n\nI'd assumed that the machine wouldn't try to access the card until the embroidery button was pressed.  Presumably this isn't the case, and it tries to access it \nas soon as the machine is turned on (which would explain the failing to start, random movements, etc). My hunch is that it's trying to read the embroidery card before the Pico has started running its code.  \n\nThe wkerwake/PicoROM has a reset pin that can be toggled when the Pico is ready, to [reboot the host machine without powering off to deal with this](https://github.com/wickerwaka/PicoROM/?tab=readme-ov-file#standalone).  I don't have a way of doing this, since it's a hardware switch on the sewing machine.  He suggests it takes ~8ms to copy the rom from flash + the time for the Pico to boot. [I found a forum post that suggested 18ms for boot time](https://forums.raspberrypi.com/viewtopic.php?t=303331#p1816483).   \n\n\nTim suggested just writing the ROM image to a flash chip, and using this directly.  One of the pages on the  [PES2Card](http://www.knitandsew.demon.nl/p2c/pes2card3.htm) page [lists the chips used in the various official aftermarket cards that used to be available](http://www.knitandsew.demon.nl/p2c/jancard.htm).   I've ordered [a chip to use](https://www.ebay.co.uk/itm/388232058408), which I plan to program using an Arduino and [this code](https://github.com/warber0x/FMPUNO). This was written to write Gameboy ROM images, and uses the same chip, so fingers crossed that will work.\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}